<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Intro to MapView - Create a 2D map - 4.12</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.12/esri/themes/light/main.css" />
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #titleDiv {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 17px;
            font-weight: 700;
            padding: 10px;
            width: 250px;
            text-align: center;
            background: #00704A;
            color: #ffffff;
            border: 7.5px solid #27251F;
        }
    </style>

    <script>
        var dojoConfig = {
            async: true,
            tlmSiblingOfDojo: false,
            packages: [{
                name: "fcl",
                location: location.pathname.replace(/\/[^/]+$/, '') + "/fcl"
            }],
            has: {
                "esri-promise-compatibility": 1 // enable native promises and remove the warning about using when() instead of then(). https://developers.arcgis.com/javascript/latest/guide/release-notes/index.html#improved-compatibility-with-javascript-promises
            }
        };
    </script>

    <script src="https://js.arcgis.com/4.12/"></script>

    <script>
        require(["esri/Map",
                "esri/views/MapView",
                "esri/geometry/SpatialReference",
                "esri/symbols/SimpleMarkerSymbol",
                "esri/symbols/SimpleLineSymbol",
                "esri/renderers/ClassBreaksRenderer",
                "esri/PopupTemplate",
                "fcl/FlareClusterLayer_v4",
                "dojo/ready",
                "dojo/text!./starbucks.json"
            ],
            function (Map,
                MapView,
                SpatialReference,
                SimpleMarkerSymbol,
                SimpleLineSymbol,
                ClassBreaksRenderer,
                PopupTemplate,
                fcl,
                ready,
                data) {

                ready(function () {
                    var map = new Map({
                        basemap: "streets"
                    });
    
                    var view = new MapView({
                        container: "viewDiv",
                        map: map,
                        zoom: 4,
                        center: [-99.370276, 37.688814] // longitude, latitude
                    });
    
                    var allData = JSON.parse(data);
                    view.when(function (e) {
                        console.log('map view loaded');
                        initLayer(allData);
                    }, function (err) {
                        console.error(err);
                    })
    
                    function initLayer(data) {
                        // default symbol
                        var defaultSym = new SimpleMarkerSymbol({
                            size: 6,
                            color: "#FF0000",
                            outline: null
                        });
    
                        var renderer = new ClassBreaksRenderer({
                            defaultSymbol: defaultSym
                        });
                        renderer.field = "clusterCount";
    
                        var smSymbol = new SimpleMarkerSymbol({
                            size: 22,
                            outline: new SimpleLineSymbol({
                                color: [221, 159, 34, 0.8]
                            }),
                            color: [255, 204, 102, 0.8]
                        });
                        var mdSymbol = new SimpleMarkerSymbol({
                            size: 24,
                            outline: new SimpleLineSymbol({
                                color: [82, 163, 204, 0.8]
                            }),
                            color: [102, 204, 255, 0.8]
                        });
                        var lgSymbol = new SimpleMarkerSymbol({
                            size: 28,
                            outline: new SimpleLineSymbol({
                                color: [41, 163, 41, 0.8]
                            }),
                            color: [51, 204, 51, 0.8]
                        });
                        var xlSymbol = new SimpleMarkerSymbol({
                            size: 32,
                            outline: new SimpleLineSymbol({
                                color: [200, 52, 59, 0.8]
                            }),
                            color: [250, 65, 74, 0.8]
                        });
    
                        renderer.addClassBreakInfo(0, 19, smSymbol);
                        renderer.addClassBreakInfo(20, 150, mdSymbol);
                        renderer.addClassBreakInfo(151, 1000, lgSymbol);
                        renderer.addClassBreakInfo(1001, Infinity, xlSymbol);
    
                        var popupTemplate = new PopupTemplate({
                            title: "{name}",
                            content: [{
                                type: "fields",
                                fieldInfos: [{
                                    fieldName: "name",
                                    label: "Name",
                                    visible: true
                                }, ]
                            }]
                        });
    
                        var options = {
                            id: "flare-cluster-layer",
                            clusterRenderer: renderer,
                            spatialReference: new SpatialReference({
                                "wkid": 4326
                            }),
                            singlePopupTemplate: popupTemplate,
                            xPropertyName: "longitude",
                            yPropertyName: "latitude",
                            data: data
                        };
    
                        clusterLayer = new fcl.FlareClusterLayer(options);
                        map.add(clusterLayer);
                        clusterLayer.on("draw-complete", function () {
                            console.log('draw complete');
                        })
                    }
                })
            });
    </script>
</head>

<body>
    <div id="viewDiv"></div>
    <div id="titleDiv">Starbucks Locations</div>
</body>

</html>